language: cpp
sudo: required
dist: trusty
osx_image: xcode7.3

os:
  - linux
  - osx

compiler:
  - clang
  - gcc

matrix:
  exclude:
    - os: osx
      compiler: gcc

env:
  global:
  #encrypted HOMEBREW_GITHUB_ACCESS_TOKEN for publishing to homebrew-tap
  - secure: "R0GrdfpPxuwMUXDVFtwFyNdOi34CV2o6NlVlLYygtVFtk7YrquB0H/xB+i6Rg/KhVIqOironxWbDUbcBCnVhGbVGMYCd4c90UAcqe6W+dUC70MpsITJXixeNwYr0nn6e09XDIQhlv1gYeGZGQlylJaZhMDwdBSp8Wnxo5jnDTLFpe1mvyOle4V4b3ekVgpEzgulUSsof0GxjN6dTukUEfFusnfOGfNhBeve/mjsWbH5THIfWeYyMn8KAQOH3eO6QHbz42GLExQw1Q7Az1U3ufVzSaG+4keVqmFQ2D2VdAMkXCOU5Ah8nr7yYKTvdkvtPeOjrub+h+/jdkM7dvKjGuC4ArK2tyiDCICypgo8DC87cRPAyPdw+nQzoOH3Gj60Cb/0rSurYviGDIEi57OgznEqHMbiefhTWnCHugZ+ZAhwTXDRvA7uZ/1G96RwiaarJbdZrWRpjSwEdeHLiaIUSFWEV806Pz3dGzDu/poEdBUumFGPum6UlYufQVBvLK26W2SsBbulU/ILPYpb0/cPcuDDGFlNyZfviVS2x5cJpkp0srnY7CEclUp/oESDFyyerDTBUKtduO0ihKhgPNWHJpiwc1368PjHMyIvH0RyXsRBEpKe3Wi722+ajYZF8gh6foe7lmVBfdWhkd78dsxlpcsmGbdipO+8Dq0GjrCDZTRQ="
  - PRORAB_GIT_USERNAME=igagis
  - PRORAB_GIT_ACCESS_TOKEN=$HOMEBREW_GITHUB_ACCESS_TOKEN

before_install:
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then
    echo "deb https://dl.bintray.com/igagis/deb /" | sudo tee /etc/apt/sources.list.d/igagis.list > /dev/null &&
    sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 379CE192D401AB61 &&
    sudo apt-get update -qq &&
    sudo apt-get install -qq debhelper prorab doxygen libutki-dev libnitki-dev libpulse-dev;
  fi
- if [ "$TRAVIS_OS_NAME" == "osx" ]; then
    rvm use ruby-2.2.1 &&
    pod repo add --silent igagis https://$HOMEBREW_GITHUB_USERNAME:$HOMEBREW_GITHUB_ACCESS_TOKEN@github.com/igagis/cocoapods-repo.git &&
    pod install --project-directory=ios &&
    
    brew tap igagis/tap &&
    brew update > /dev/null &&
    brew install prorab libutki libnitki;
  fi


script:
- if [ "$TRAVIS_OS_NAME" == "linux" ]; then
    prorab-deb-prepare.sh &&
    dpkg-buildpackage -us -uc;
  fi
- if [ "$TRAVIS_OS_NAME" == "osx" ]; then
    make &&
    
    xcodebuild -workspace ios/tests.xcworkspace -scheme tests CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO;
  fi

before_deploy:
  - prorab-apply-version.sh -v `prorab-deb-version.sh debian/changelog` travis_bintray.json.in

deploy:
- provider: bintray
  skip_cleanup: true
  on:
    tags: true
    condition: $TRAVIS_OS_NAME = linux && $CC = gcc
  file: travis_bintray.json
  user: igagis
  key:
    secure: "hM788IuVegYWTiV9tzrWHbh1dyZv4mE8Nq+hE7W8ReZ1Lp5wsW50PCg4pZE1BcZrA69C5pPmUcqNBB7RcV+Ip2WszTKNH/gNWMtKx3PYSuca3yJX8seO4hNMKLvImH7BYpOz4GP4rjonSXRu752Uf4uMjzTCW1KS4FSQhne3bI+DKHcjC64tQlguOwk7LtTPK/P972tNltTHnK14dJm+4JEmZdtppvFdeCtb4j3+KgYuV+fdO3ztg6eHgqMvr6Qq9CXNKVC8X+pQRjw7sRHqgwweycOJLPxLrjI9Hv3RpFD2h+HqI56sJWX0u5BwMkE7v4lpZlWGB1dII7FM5jgGHuyovWNNxCZgjmUKwMcJQQ2rN/TUhaQolgeiV/sXbVCKCy2smgx1Rt+SajQvnAKwkU78rlYAF2dej4UYLeyxI76B6JNR92VqK9rY7yA+tbok7xCEyyfQp5cfD3AfL/hXY0/DDMVFRDI0WegUQTPOnIgdLtU8jKTXK0XlCs0hj74jCIEwmr7LgK65K+H0ZgYGJNzUwHay8hDUHFfCtlF4ClY8ypYVAMRxmU2cNoxLCo+vc8sk4qeVd6aAVdJDmBhK1Bz0jx4isBj561PissrCVocQYJypKPIpj2eMBo8Im6nyVTRpQd5gyBzUcr/sWgY+RpM+qRqGShQKl9nzPceO9xc="
  dry-run: false
- provider: script
  skip_cleanup: true
  script: prorab-deploy-homebrew.sh igagis/tap
  on:
    tags: true
    condition: $TRAVIS_OS_NAME = osx && $CC = clang
- provider: script
  skip_cleanup: true
  script: rvm 2.2.1 do prorab-deploy-cocoapods.sh igagis
  on:
    tags: true
    condition: $TRAVIS_OS_NAME = osx && $CC = clang
